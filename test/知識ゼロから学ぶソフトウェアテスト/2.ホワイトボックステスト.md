# 2. ホワイトボックステスト

- ソフトウェア黎明期に研究された手法
- 実務で有用とは限らない

## 2.1 ホワイトボックステストとは

- プログラムの論理構造が正しいか解析するテスト
- コンピュータのリソースが限られていた時代に人間の時間を多く使って内部構造を調べる

### 2.1.1 どんなテスト手法が有効か

- 限られた時間ですべてのテストを完了させるためにテスト手法を十分吟味することが必要
- 論理構造の正しさのみをテストするので、仕様が間違っていることから起こるバグは防げない

## 2.2 プログラムの振る舞いをテストする -制御パステスト法-

- プログラムの振る舞い制御の仕方をテスト
- カバレッジ率取得のために使われる

## 2.3 大人気ゲームソフトのバグ

- フローチャート上のいくつかの条件が重なったときに発生する不具合
- このような不具合を防ぐためには、このようなフローチャートをすべてカバーするのが重要

## 2.4 ステートメントカバレッジ

- 制御パステストのうち一番簡単な方法
- テストとしては弱い手法
- 下記の (1), (2) をそれぞれ満たすケースだけをテスト
  - (con1, con2) = (0, 2)

```c
if (con1 == 0) {
  x = x + 1; // (1)
}
if (con2 > 1) {
  x = x * 2; // (2)
}
```

## 2.5 ブランチカバレッジ

- それぞれの判定条件が True, False の結果をそれぞれ少なくとも1つもつ
  - (con1, con2) = (0, 2), (1, 1)
- ステートメントカバレッジよりは強い
- テストケースは多くなる
- ブランチカバレッジをプログラム全体に使用しなくても、成果は得られる
  - バグが出やすい箇所でブランチカバレッジを適用するのもアリ

## 2.6 カバレッジ基準

- 一般的に60%~90%カバーできれば十分
  - 学術的・経験的な正解がなく難しい
- バグが致命的とされる分野 (車、飛行機のような人命に関わる部分のソフトウェアなど) では 100% が要求される
- HP のデータでは20%~80%までの振れ幅があった
- テスト担当者がコードまで見るのは難しい場合、カバレッジ結果を開発者に共有して、意見を求めるのもアリ

### 2.6.1 カバレッジテストでカバーできないコード

- エラー処理
  - 再現が難しい

```c
char *string; /* 動的メモリ領域の確保 */
string = malloc(_MAX_PATH);
if (string == NULL) {
  printf("メモリあありません\n");
  return FALSE;
}
```

- 使われていないコード

## 2.7 カバレッジテストで検出できないバグ

- カバレッジテストですべてのバグを見つけるのは理論的に不可能
- 例)
  - ループのバグ
  - 要求仕様自体の間違い、機能が備わっていないバグ
  - データに関するバグ
  - タイミングに関するバグ

### 2.7.1 プログラムのループ

- カバレッジ基準が定義されていないため、カバレッジテストの効果が期待できない
- テストの対象とすべき要件
  - ループしない (スキップされる) 場合
  - ループの回数が1の場合
  - 最も典型的なループ回数
  - 最大ループ回数より1少ない回数
  - 最大ループ回数
  - 最大ループ回数より1多い回数

### 2.7.2 要求仕様自体の間違い、機能が備わっていないバグ

- 仕様自体が間違いの場合
  - 一般的にユーザー (ソフトウェアについて詳しくない) の要求を要件に落とし込むのが一番難しい
- 機能自体がない場合

### 2.7.3 データに関するバグ

- 昨今では制御のバグより多いかも
- 例)
  - データの排他制御
  - データベースの処理
  - 外部からのデータの取得

### 2.7.4 マルチタスクや割り込みに関するバグ

- データはプロセス・スレッド間で共有されているかをチェック
  - 共有されていたらデータへのアクセスパターンを分析し、テストケースを作成
- プロセス・スレッドについて生成・消滅の組み合わせをテスト
- できるだけ多くのプロセス・スレッドを立ち上げてテスト
  - プロセス・スレッドが突然死んだり、ゾンビ化したりする場合がある
- とはいえ、まだ対処療法的な方法しかない

## 2.8 カバレッジテストの罠

- カバレッジデータやカバレッジ手法に振り回されない
  - 自分たちが設定した目標を達成することが重要
  - そのためには、製品によって品質の目標を妥当に設定するのが必要
- テストに対する予算をしっかり組む必要がある
  - カバレッジテストは非常にコストがかかる
  - カバレッジ率100%に近づくにつれて、コストが等比級数的に増加していく

## 2.9 ホワイトボックステストの復権 (TDD)

- 1960's にテスト手法が生まれたときの主流な方法
- 1990's になると大きいサイズのコードを効率的にテストするにはブラックボックステストが有効という流れに
- 2010's にアジャイルの XP (eXtreme Programming) やスクラム手法が流行り始めると、ホワイトボックステストが再び脚光を浴びるように
  - ホワイトボックステストを用いた単体テストは MUST
  - TDD

### 2.9.1 アジャイルとは

- 短いサイクルでコーディング・テストを行い、変更に強い
- XP にはテスト・リファクタリング・継続した結合という要素が明確に定義されている

2.9.2 TDD の単体テストを書く

- TDD → 赤・緑・リファクタ
  - 赤
    - 小さい動作しないテストを書く
    - コンパイルは通る必要はない
  - 緑
    - テストを通すコードを書く
  - リファクター
    - 重複したコードの削除
- 「単体テストをやってる暇がない」という execuse が通用しなくなる

### 2.9.3 リファクタリング

- アジャイルでは気軽にリファクタリングできる
- TDD の本質は、品質の保証よりも、変更への耐性にある
- TDD だけでは品質は担保できないので、テスト担当者が責任をもって品質保証する必要がある
