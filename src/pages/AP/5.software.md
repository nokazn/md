# 5. ソフトウェア

- 広義の OS
  - 制御プログラム
    - カーネル
      - ジョブ
      - タスク (プロセス)
      - 記憶装置
      - 割り込み処理
      - 入出力
      - システムコール
    - ファイルシステム
    - デバイスドライバ
  - 言語プロセッサ
    - アセンブラ
    - コンパイラ
      - セルフコンパイラ
      - クロスコンパイラ
    - インタプリンタ
    - プリプロセッサ
  - サービスプログラム (ユーティリティ)

## 5.1 OS の構成と機能

### 5.1.1 基本ソフトウェアの構成

- 広義の OS
  - 制御プログラム (狭義の OS)
  - 言語プロセッサ
  - サービスプログラム (ユーティリティ)

### 5.1.2 制御プログラム

- 制御プログラム
  - カーネル
  - デバイスドライバ
  - ファイルシステム

#### カーネル

- カーネル (スーパーバイザプログラム)
  - ジョブ管理 (利用者側)
  - タスク管理 (コンピュータ側)
  - 記憶管理
  - 割り込み管理
  - 入出力管理
  - 応用プログラムへのシステムコール

##### ジョブ

- 利用者からみたコンピューターで実行されるひとまとまりの仕事の単位
- ショブスケージューラを構成する リーダ → イニシエータ → ターミネータ → ライタ の順に処理される
- 1つ以上のジョブステップから成り、ジョブステップはタスクまたはプロセスから成る

- ジョブ
  - ジョブステップ1
    - タスク
    - プロセス
  - ジョブステップ2
    - タスク
    - プロセス
  - ...

###### ジョブ管理

- JCL (Job Control Language / ジョブ制御言語) を介してジョブをいい感じに処理させる機能
- 低速の入出力処理やプログラムの実行を切り離すスプーリング機能
  - スループットの向上につながる
- 複数ジョブのスケーリング

##### タスク

- コンピューターからみた CPU の割り当て単位
- CPU効率を考慮押して適切な順番でCPU時間を与える

##### 記憶管理

- プログラムを実行する実アドレス空間を管理

#### デバイスドライバ

- カーネルから依頼を受け、入出力装置を操作・管理するプログラム
- 装置の種類ごとに用意される
- デバイスドライバをカーネルに組み込むと新しいデバイスの追加の際にカーネルのリコンパイルが必要になってしまうので切り離されている

### 5.1.3 カーネルモードとユーザーモード

CPU には2つの実行モードがある

### カーネルモード  (特権モード)

- カーネルのみが実行できる特殊命令の実行 (システムコール) を許可するモード

#### ユーザーモード

- ユーザープログラムの実行を許可するモード
- ユーザープログラムがカーネルに処理を依頼するためシステムコールを発行し、カーネルはパーミッションを確認したうえで処理を実行する

### マイクロカーネルとモノシリックカーネル

カーネルへの機能の持たせ方によって2つに分けられる (最近は区別は曖昧)

#### マイクロカーネル

- カーネルには最小限の機能のみ
- そのほかの機能はサーバープロセスとして呼び出して利用
- Windows など

#### モノシリックカーネル

- OS が担うほとんどの機能をカーネルにもたせる
- プロセス切り替えが少なく、処理が高速
- 主記憶を効率的に使用できない
- Linux など

## 5.2 タスク (プロセス) 管理

### 5.2.1 タスク (プロセス) の状態と管理

#### プログラムとタスク

- CPU からみた処理単位で、CPUや主記憶などのリソースを割り当てるときの単位
- UNIX 系ではプロセスと呼ぶ
- 主記憶の実行プログラムをインスタンス化してCPUで識別する単位みたいなイメージ
- マルチプログラム (CPU の空き時間に別タスクを行う) 環境で、同じプログラムが実行されている際にそれぞれを CPU が区別できるようにする

#### タスクの状態遷移

##### ライフサイクル

- 実行可能状態 (ready state)
  - CPU 使用権が与えられるのを待っている
- 実行状態 (running state)
  - CPU 使用権が与えられ、処理を実行している
- 実行待機状態 (wait state)
  - 入出力の完了
  - 他のタスクからの合図の待機

TODO 割り当ての図

##### 状態遷移

- ディスパッチング (dispatching)
  - ready → running
  - ディスパッチャにより実行状態へ移される
- プリエンプション (preemption)
  - running → ready
  - 実行中のタスクの CPU 使用権を奪って中断させ、後で実行させる
  - タイマ割り込みなど

#### タスクの管理

カーネルがタスクを生成し、TCB (Task Control Block / タスク制御ブロック) に登録

##### 登録されるタスク情報

- タスク ID
- 優先順位
- タスクの状態
- レジスタ群格納アドレス
  - PSW (Program Status Word) へのアドレス
    - プログラムカウンタ
    - 割り込み情報
    - 実行モード
  - レジスタ群
- プロテクション状態・実行時間など

#### タスクの切り替え

- コンテキスト切り替え (コンテクストスイッチ)
  - CPU が保持する実行中ノプログラムの情報 (PSW など) と主記憶のアドレス空間の内容を切り替える
  - レジスタの切り替え (CPU 内の実行状態を保持する記憶装置) の切り替えは高速
  - 主記憶のアドレス空間の切り替えは低速
  - [スレッド](TODO) はタスク (プロセス) の切り替えより高速

### 5.2.2 タスクのスケジューリング

カーネルのスケジューラが実行待ち状態 (wait state) のタスクから実行するタスクを選択

#### スケジューリング方式

- 切り替えのきっかけ (**トリガ**) とどのタスクを優先するか (**優先度**) の観点がある
- トリガ
  - イベントドリブン方式
    - 環境の変化をトリガとする
  - タイムスライス方式
    - タイムクウォンタムごとにスケジューリング
  - イベントドリブン+タイムスライス
    - 例) 優先度の高いものにはイベントドリブン、それ以外はタイムスライス
    - ラウンドロビン方式など
- 優先順位
  - 到着順方式 (FCFS)
    - 優先順位なし
  - 静的優先順位方式
  - 動的優先順位方式

##### 到着順方式 (FCFS / First Come First Served / ノンプリエンプション方式)

- 実行可能状態 (ready state) になった順に実行

##### 静的優先順位方式 (プリエンプション方式)

- 予め決まった優先順位の高いものから実行

##### 動的優先順位方式 (エージング方式)

- 待ち時間が一定時間以上となったタスクの優先順位を動的に高くして実行

##### ラウンドロビン方式

- 実行可能待ち (ready state) 行列内の先頭から CPU 実行時間 (タイムクウォンタム) を割り当てる
- タイムクウォンタム内を超えた場合はインターバルタイマからの割り込みが発生し、実行可能待ち行列の末尾に push される
- タイムクウォンタムを
  - 長くする → 到着順方式
  - 短くする → 処理時間順方式

##### フィードバック待ち行列方式

- 最初にタスクに高い優先順位と短い CPU 時間を割り当てる
- 一定時間内に終了しない場合は徐々に CPU 時間を長くしながら優先順位を下げていく
- CPU を占有しやすいタスク優先順位が徐々に下げられる

##### 処理時間順方式 (SPT / Shortest Processing Time First)

- 処理時間の短いタスクの優先順位を高くする
- 予め処理時間はわからないので、実際はフィードバック待ち行列として実現される

##### SEPT 方式

- 処理時間が短そうなタスクを優先

##### SET方式

- すでに処理された時間が最も短いものを優先

#### プリエンプティブな OS

- タスクを中断し別のタスクを実行する機能 (プリエンプション) をもつOS
- ノンプリエンプティブな OS ではタスクが終了するか、タスクが自ら OS に制御を戻す命令を発行するまで CPU が占有し続ける

#### リアルタイムOS (RTOS)

- リアルタイム処理 (要求に即座に応じ、応答時間が一定の範囲内に収まる処理) のための機能を実装している OS
- 一定時間内に非同期処理が完了する必要のある組み込みなどシステムなどで使用される
- タスクを予め静的に生成しておき、起動すると実行可能状態へと遷移する
- ハードリアルタイムシステム
  - 一定時間内に処理が終了しない場合致命的なダメージが生じる
  - 例) エアバッグ制御システム

##### リアルタイム OS のスケジューリング

タスクのトリガは割り込みで、割り込みハンドラが実行される

- イベントドリブン方式 (イベントドリブンプリエンプション方式)
  - 優先度を静的に決定
- デッドラインスケジューリング方式
  - 優先度を動的に決定

### 5.2.3 同期制御

- ほかのタスクと協調しながら処理をすすめる

#### イベントフラグ

- 16bit と 32bit がある
- `SET` システムコール
  - ビットを ON
  - ディスパッチ
- `CLEAR` システムコール
  - ビットを OFF
  - プリエンプション
- `WAIT`システムコール
  - ビットが ON になるまでタスクを待たせる

#### Post / Wait 命令

- 1つのイベントフラグを Post と Wait で表現
- 生産者 - 消費者

#### タスク (プロセス) 間通信

- 記憶空間共有型
  - 共有メモリ領域 (Shared Memory) を用いる
- OS が提供する機能
  - 例) メールボックス、メッセージキュー
- パイプ機構
  - ファイルやメモリを経由
  - あるタスクの出力をタスク別のタスクの入力とする

### 5.2.4 排他制御

#### クリティカルセクション

- 同時に更新すると不整合を引き起こす部分
- クリティカルセクションを制御する方法に排他制御がある
  - あるタスクがクリティカルセクションを実行中のとき、ほかのクリティカルセクションのプリエンプションを発生させない
  - TSL (Test and Set Lock) 命令
    - 共有メモリ内の1ビットを用いてロック・アンロックのロジックを実現
    - 割り込みの禁止はマルチ CPU システムでは無意味

#### 2値セマフォ

- ダイクストラによって考案
- クリティカルセクションに入れるタスクは1つ
- セマフォ変数、P操作、V操作から成る
- TODO

#### ゼネラルセマフォ

- n個のタスクをクリティカルセクションに入れる場合に用いる
- TODO

#### ENQ / DEQ 命令

- ENQ
  - 共有資源の占有
  - ロック、セマフォのP操作にあたる

- DEQ
  - 共有資源の解放
  - アンロック、セマフォのV操作にあたる

### 5.2.5 デッドロック

複数のタスクが互いに占有解除の命令を待機している状態

#### 発生条件

TODO

#### 対策

- 発生したら検出して対処
- 静的防止法
  - 予め割り当ての解放順を決める
- 動的防止法
  - リソースの割り当て状況によって動的に割り当てる

### 5.2.6 プロセスとスレッド

- タスク $ \simeq $ プロセス ($$ タスク \supseteq プロセス \supseteq スレッド $$)
  - 1つのプログラムを実行する処理単位
- プロセス
  - スタック + CPU レジスタ群のセットを持つ
  - 別プロセスは独立したアドレス空間のため、主記憶の利用効率が悪くなる
- スレッド (軽量プロセス)
  - スタック + CPU レジスタ群のセットを持つ
  - CPU 資源のみ割り当てられ、その他はプロセスないで共有するため、主記憶の利用効率が良い
  - スレッド間の排他制御が必要

## 5.3 記憶管理

- 記憶管理
  - 実記憶管理
  - 仮想記憶管理

### 5.3.1 実記憶管理

- 主記憶装置 (実記憶装置) のつくる記憶空間を実アドレス空間という
- マルチタスク環境では実アドレス空間の割り当てがシステム全体の効率にとって重要
- 割り当て方式
  - 単一連続割当方式
  - 固定区画方式
  - 可変区画方式
  - オーバーレイ方式

#### 単一連続割当方式

- 主記憶を1つのタスクにのみ割り当てる

#### 固定区画方式 (パーティション方式)

- 固定長の区画に分割し、割り当てる
- 区画内に未使用領域 (ガーベジ) が発生する (**内部フラグメンテーション**)

#### 可変区画方式

- タスクの大きさに応じて主記憶領域を可変長の区画に区切って割り当てる
- 区画の割り当て・解放を繰り返すことで主記憶上に不連続な未使用領域が発生する (**外部フラグメンテーション**)
- 不連続な未使用領域を1つの連続的な領域にまとめる操作 (**メモリコンパクション**) によって**動的再配置**が行われる

##### 未使用領域割り当て方式

可変区画方式で未使用の領域の割り当ての方法は以下のようなものがある

| アルゴリズム | 説明 |
| --- | --- |
| 最初適合アルゴリズム | 必要量を満たすもののうち、最初に見つかったものを割り当て |
| 最良適合アルゴリズム | 必要量を満たすもののうち、最小のものを割り当て |
| 最悪適合アルゴリズム | 必要量を満たすもののうち、最大のものを割り当て |

#### オーバーレイ方式

- 予めプログラム排他的な複数のセグメントに分割しておき、実行時に必要なセグメントを主記憶に読み込ませて実行
- 主記憶より大きなプログラムを実行することができる
- TODO

#### スワッピング (スワップイン・スワップアウト)

- 長時間待機状態にあるプログラムなどを補助記憶に退避 (スワップアウト) し、プログラム再開時には対比した状態を読み込ん (スワップイン) で実行
- Linux ではデフォルトで主記憶装置の2倍のスワップ領域が確保される

### 5.3.2 仮想記憶管理

- 磁気ディスク装置を利用し、実アドレス空間より大きい仮想アドレス空間を想定する
- プログラム実行時は **MMU (Memory Management Unit)** が**仮想アドレス**を主記憶の実アドレスに変換 (**動的アドレス変換 (DAT / Dynamic Address Translator)**) する
- 仮想記憶方式
  - ページング方式
    - 固定長のページという区画に分割し、主記憶上にも同じ大きさのページに分割
    - ページ単位でアドレス変換
    - 一般的
  - セグメント方式
    - 可変長のセグメントという論理的な単位で分割
    - セグメント単位でアドレス変換

#### 5.3.3 ページング方式

- 仮想アドレスと実アドレスの対応を**ページテーブル**を用いて管理

#### アドレス変換

- 仮想アドレス
  - ページ番号
  - ページ内での相対アドレス
- ページテーブル
  - ページ番号
  - 主記憶上のページ枠の先頭のアドレス
    - 実アドレス = 先頭のアドレス + ページ内での相対アドレス
  - ページフォールトビット
    - 存在の有無を示すフラグ (0 → 存在, 1 → 存在しない)
- TLB (Translation Look-aside Buffer / アドレス変換バッファ / 連想レジスタ)
  - キャッシュ機構を用いて高速化
  - 最近のアクセス履歴を保持

#### ページング (ページイン / ページアウト)

- **プリページング**
  - 実行に必要なページを予め予測して主記憶に読み込む
  - 実際は難しい
- ページフォールト割り込み
  - 必要となったページが実アドレス空間上に存在しない (ページフォールトビットが 1) 場合に発生
  - デマンドページング
    - 主記憶上に空きページ枠がある場合は該当ページをそこにページイン
    - 主記憶上に空きページ枠がない場合はページ置き換えをアルゴリズムによって追い出し (ページアウト)、空いた枠ににページイン
  - ページ置き換えアルゴリズム
    - LRU (Least Recently Used)
    - LFU (Least Frequently Used)
    - FIFO (First In First Out)

#### LRU によるページ置き換え

TODO

#### LRU, FIFO の基本的な考え方

TODO

#### 割り当て主記憶容量とページフォールトの関係

- LRU
  - ページフォールト発生率は割り当て主記憶容量に反比例
- FIFO
  - 割り当て主記憶容量を増やすとページフォルト発生率も上昇する場合あり
  - TODO

#### スラッシング

- 主記憶の容量が不十分な場合プログラムの多重度に応じてペ－ジング処理が多発し、CPU 使用率が上昇

ワーキングセット

- 局所参照性
  - 参照された場所の近くが引き続き参照される可能性が高い性質
- **ワーキングセット**
  - OS が管理している各時点で局所参照されたページをまとめたもの

## 5.4 言語プロセッサ

### 5.4.1 言語プロセッサとは

高水準言語などを解釈するプログラム

- アセンブラ
  - アセンブリ言語 → 機械語
- コンパイラ
  - 高水準言語 → 機械語
- インタプリンタ
  - 命令を逐一解釈し、実行
- プリプロセッサ
  - ある高水準言語から別の高水準言語に変換

### 5.4.2 その他の言語プロセッサ

#### ジェネレータ (生成系)

- 処理条件となる入力、出力、引数を指定し、プログラムを生成
- 例)
  - Lex
    - UNIX 系の字句解析ツール
  - Yacc
    - UNIX系の構文解析ツール

#### シミュレータ (実行系)

- 他のコンピュータ用のプログラムを解読しながら実行
- これを行うハードウェア (マイクロプログラム) を**エミュレータ**という
  - 例) VT100 などの端末エミュレータを用いて telnet クライアント上でホストコンピュータの機能を実現

### 5.4.2 コンパイラの技法

#### コンパイラの処理手順

| 処理 | 内容 |
| --- | --- |
| 字句解析 | 意味を持つ最小単位である字句 (**トークン**) に分割 |
| 構文解析 | トークンをプログラム言語の構文規則に則って解析 |
| 意味解析 | プログラム内のデータの整合性チェックなどを行い、同じ意味の別表現に直す<br />一般的に、最適化処理の前処理のため、3つ組、4つ組、逆ポーランドなどにより**中間コード**を生成 |
| 最適化 | レジスタの有効利用のための変数レジスタ割付や不要な演算の除去など |
| コード生成 | 目的プログラムとしてコードを生成 |

#### コンパイラの最適化手法

1. 実行速度の最適化
   - べき乗を乗算、乗算を加算に変換
   - 更新されない変数を定数に置き換え
   - 関数のインライン展開を行い、呼び出し時間節約
   - ループ中で一定な値はループの外側に追いやる
   - **ループアンローリング**(ループ展開)
     - コードサイズとトレードオフ
2. コードサイズの最適化
   - 冗長部分を除去
   - 変数の初期値や定数の共通部分をまとめる

また、両方の観点から以下のような最適化も考えられる

- 変数をレジスタに割り当て
- 定数の畳み込み
- 不要な演算を省略

### 5.4.3 リンク (連係編集)

- リンク
  - コンパイラによって生成された目的プログラムをリンカによって実行可能プログラム (**ロードモジュール**) にするためにモジュールをまとめる
- 静的ライブラリ
  - 実行前に静的にリンク
- 動的ライブラリ
  - 実行時に動的にリンク
- 共有ライブラリ
  - 実行時に動的にリンク
  - 別のプログラムからも同時に利用可能なため、主記憶の利用効率はよくなる

#### コンライル・リンクの自動化ツール (make)

make によってプログラムの変更のたびに依存関係を解決し、プログラムをコンパイルする

## 5.5 開発ツール

### 5.5.1 プログラミング・テスト支援

#### 静的テストツール

- 構文チェッカ
- コードオーディタ (リンタ)
  - コーディング規約違反を検出
- モジュールインターフェースチェックツール
  - モージュール間のインターフェースの整合性チェック

#### 動的テストツール

- トレーサ (追跡プログラム / デバッカ)
  - 命令単位などでプログラムを実行し、実行直後のレジスタの内容やメモリの内容の情報を得る
- テストカバレージツール
  - プログラムの存在経路をどれだけテストしているか (網羅率) を調べる
  - [ホワイトボックステスト](TODO)
- アサーションチェッカ
  - 実行時に指定した条件を満たすかを調べる
- プロファイラ
  - プログラムの性能を分析
    - 構成するモジュール
    - 関数の呼び出し回数
    - 関数呼び出しにかかる時間
    - 実行時のメモリ使用量
    - 実行時のCPU使用量
- スナップショット
  - プログラムの命令実行ごとに指定されたメモリやレジスタの内容を出力
- インタスペクタ
  - プログラムが使用するデータ内容を表示
- テスト支援ツール
  - テストベッドツール
    - テストの動作環境を整備
  - テストデータ生成ツール
    - テストデータのデータ構造を与え、自動的にテストデータを生成

### 5.5.2  CASE ツール (Computer Aided Software Engineering)

#### CASE ツールの構成

- ソフトウェア開発、保守作業の効率化・自動化を支援するツールで、80~90年代に流行
- RAD ([Rapid Application Development](TODO)) などで用いられる
- 支援範囲
  - 上流CASE
  - 下流CASE
  - 統合CASE

#### リポジトリ

- 開発・保守における情報を一元的に管理するデータベース
  - データの所在
  - ファイルの使用
  - プログラム間の関連
  - 各種プログラム
- バージョン管理が必要
- メタデータ
  - データ定義情報
- データディクチョナリ
  - メタデータを収集し、管理したもの

### 5.5.3 ソフトウェア構成管理ツール

- ソフトウェア構成や構成アイテムの変更履歴を管理
- ソフトウェアの一貫性を保ち、管理を効率的にする

#### チェックイン / チェックアウト

- チェックアウト
  - 共用のデータベースからオブジェクトの変更を取り込む
  - 参照モード (Read Only) と更新モード (Writable)
- チェックイン
  - 更新モードでチェックアウトされたオブジェクトを修正し、共用のデータベースに取り込む

## 5.6 UNIX 系 OS

### 5.6.1 ファイルシステムの構造とファイル

#### ファイルシステムの構造

- ファイル指向
  - すべてのファイルは1つの木構造で階層的に管理
- 絶対パス
  - `/` から始まるやつ
- 相対パス
  - `.` とか `..` から始まるやつ

#### ファイルの種類

- 通常ファイル
- ディレクトリファイル (ディレクトリ)
  - ディレクトリ内のファイルと i ノード番号が保持されている
    - ファイルの種類
    - 所有者
    - サイズ
    - 作成日時 / 修正日時
- 特殊ファイル (スペシャルファイル)
  - キャラクタスペシャルファイル
    - 文字単位で入出力
    - 例) 端末、プリンタ
  - ブロックスペシャルファイル
    - ブロック単位で入出力
    - 例) 磁気ディスクのようなデバイスなど

### 5.6.2 UNIX 系 OS の基本用語

#### シェル

- OS (カーネル) とユーザーのインターフェース
- コマンドを解釈し、OS に命令を出し、結果をユーザーに返す

#### リダイレクション

- コマンドの出力や入力を切り替える
- `>` とか `>>` とか

#### パイプ

- コマンドの入力を出力に受け渡す
- `ls -Al | more` とか

#### デーモン

- OS の機能の一部を提供するプロセス
- OS 起動時または必要に応じて起動される
- バックグラウンどで常に動作

#### ソケット

- アプリケーション間で TCP/IP ネットワークを通じて通信するしくみ (プロセス間通信の API)
- 狭義では、IP アドレスとポート番号を合わせたアドレス

### 5.6.3 OSS (オープンソースソフトウェア)

- ソースコードの利用や改変、再頒布を行うことができるソフトウェア
- OSI (Open Source Initiative) が OSD (the Open Source Definition) にて定めている

#### 定義

- 派生物
  - 一定条件下で改変可
- 頒布
  - 第三者へ提供
- 再頒布
  - 頒布したものを頒布
  - 派生物を頒布
  - ライセンスを継承
- 使用 (use)
  - 享受するだけ
  - 誰でも実行、コンパイル、閲覧可能
- 利用 (exploit)
  - 一定条件下で複写、改変 (再頒布) 可

#### 特徴

- 派生物の再頒布可能
- 誰でも使用できる
- ライセンス分配
- 環境に拠らない
- 技術的に中立

#### LAMP

- Linux + Apache + MySQL + PHP / Python / Perl

#### LAPP

- Linux + Apache + PostgreSQL + PHP / Python / Perl

### コンピュータグラフィックス (CG / Computer  Graphics)

| 技法 | 説  |
| --- | --- |
| マルチメディアオーサリングツール | 画像、音声、文字などを組み合わせて作品をつくるツール |
| アンチエイリアシング | 斜めや曲線を目立たなくする |
| クリッピング | ウィンドウ内の見える部分だけを切り出す |
| シェーディング | 陰付け |
| レイトレーシング | 光の反射や透過を表現<br />視点から見えない面を画面に表示しないようにする |
| メタボール | 物体を球や楕円体の集合としてモデル化 |
| ラジオシティ | 光の相互反射を利用して表面の光エネルギーを算出し、表面の明るさを決定 |
| テクスチャマッピング | モデリングされた物体の表面に柄や模様を貼る |
| ブレンディング | 画像を半透明にして重ねる |
| モーフィング | 形状の変化を動画にするために中間の状態の画像を作成 |
| サーフェスモデル | 物体をポリゴン (多角形) や曲面パッチで表現<br />3D で多く用いられる |
| ワイヤフレーム表現 | 3D の形状を線で表現 |
| レンダリング | 物体データをディスプレイに描画できるよう映像化 |
| ディザリング | 見かけ上の色数よりも少ない色数で画像データを構成すること |
