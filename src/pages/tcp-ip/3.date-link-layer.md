# 3. データリンク

## 3.1 データリンクの役割

- 用語の使われ方
  - OSI 参照モデルのデータリンク層
  - 具体的な通信手段
    - イーサネット、無線 LAN
- TCP/IP ではデータリンク層以下の役割を定義していない
- 通信媒体で直接接続され機器間で通信するための使用を策定
  - ツイストペアケーブル
  - 同軸ケーブル
  - 光ファイバー
  - 電波
  - 赤外線
- バイナリデータを「フレーム」という意味のあるかたまりにして伝える役割

### トピック

- MAC アドレス
- 媒体共有・非共有のネットワーク
- スイッチング技術
- ループ検出
- VLAN
- イーサーネット・無線 LAN・PPP

### FDDI (Fiber Distributed Data Interface)

- 伝送媒体に[光ファイバー](https://e-words.jp/w/光ファイバー.html)を、アクセス制御方式に[トークンパッシング](https://e-words.jp/w/トークンパッシング.html)を利用し、最高100[Mbps](https://e-words.jp/w/Mbps.html)で通信可能なLAN規格の一つ
- データリンク層・物理層の規格まで決まっている
- [FDDI（Fiber Distributed Data Interface）とは - IT用語辞典 e-Words](https://e-words.jp/w/FDDI.html)

### セグメント

- 区切られた1つのネットワークを示す
- ネットワーク層から見たら1つのネットワーク (論理構成)
- 物理層から見たら1つのネットワーク (物理構成)

### ネットワークのトポロジー

- トポロジー
  - 接続形態・構成携帯
  - 例)
    - バス型
    - リング型
    - スター型
    - メッシュ型

## 3.2 データリンクの技術

### 3.2.1 MAC アドレス

- 接続するノードを識別するために利用
- イーサーネット・無線LANでは IEEE802.3 で規格化された MAC アドレスが利用される
- FDDI, Bluetooth, ATM (Asynchronous Transfer Mode)
- 48bit 長
- NIC (Network Interface Card) の場合は ROM に書き込まれている
- 基本的に世界中の端末で一意
  - この制約をもとに各種プロトコル・通信機器は設計されている
  - 物理的なインターフェイスがない仮想マシン内では重複する場合も存在
- イーサネットでは、オクテットごとにデータを読み、最下位ビットから最上位ビットに向けてビット列を組み立てるため、オクテットごとにビット列の順番が入れ替わっている

| 範囲      | 名称                                     | 用途                                                |
| --------- | ---------------------------------------- | --------------------------------------------------- |
| 1 bit     | ユニキャストアドレス・マルチキャスト     |                                                     |
| 2 bit     | ユニーバーサルアドレス・ローカルアドレス |                                                     |
| 3~24 bit  | ベンダ識別子 (OUI, MA-L とも)            | IEEE がベンダごとに重ならないように管理するアドレス |
| 25~48 bit | ベンダ内識別子                           | ベンダが製品ごとに管理するアドレス                  |

### 3.2.2 媒体共有型のネットワーク

- 通信媒体から見て、以下の2つに分けられる
  - 媒体共有型
    - 基本的に半二重通信となるため、通信の優先権を制御する仕組みが必要
      - 受信している間でも送信できない・送信している間でも受信できない
    - 例)
      - 初期のイーサネット
      - FDDI
  - 媒体非共有型

#### コネクション方式 (CSMA 方式)

- データを早い者勝ちで奪い取る方式
- 複数ノード (データリンクではステーションとも) でデータが同時にそう送信された場合はデータが破損する (コリジョン)

#### CSMA/CD 方式 (Carrier Sense Multiple Access with Collision Detection)

- CSMA 方式の改良版
- 衝突を早期に検知して、素早く通信路を解放する
  - 搬送波が流れていなければすべてのステーションはデータを送信してよい
  - 衝突を検知した場合はすぐに通信と取りやめ
  - 取りやめた場合、乱数時間後に再送信する

#### トークンパッシング方式

- トークンというパケットを巡回させ、このトークンで送信権を制御する
- どのノードにも平等に送信権が回り、衝突も発生しない
  - → 速度も低下しにくい
- 派生
  - アーリートークン方式
  - アペンドトークン方式

### 3.2.3 媒体非共有型のネットワーク

- スイッチを介してステーションが接続される
- 送受信の通信媒体が共有されないため、全二重通信となる
  - 受信している間でも送信できる・送信している間でも受信できる
- イーサネットでは主流
  - イーサネットスイッチでコンピュータとスイッチのポートが1対1に接続される場合は全二重通信
  - CSMA/CD の仕組みは不要
- スイッチに高度な機能を持たせて VLAN として機能させたり、流量制限をしたりできる
- スイッチが故障するとすべてのノード間の通信が不可能になる

### 3.2.4 MAC アドレスによる転送

- 同軸ケーブル上のイーサネット (10BASE5, 10BASE2) などの通信媒体を共有する方式では同時に1つのホストしかデータを送信できません
  - ネットワーク内のホストの数が増加すると通信性能が低下する
- スイッチングハブ・イーサネットスイッチ媒体非共有型で利用されていた技術がイーサネットでも利用できるようになった
  - 例)
    - ハブ
    - コンセントレータ

#### イーサネットスイッチ

- 複数のポートを持ったブリッジともいえる
  - ブリッジ - L2 スイッチとも、ネットワークどうしを接続する
- フレーム内の MAC アドレスを見て、フォワーディングテーブル (転送表) を参照して送り出すインターフェイスを決定する
  - 転送表は自動で生成される
  - データリンク層の通過点で、インターフェイスと送信元の MAC アドレスの対応を転送表に書き込む
- MAC アドレスには階層性がないため、ホストの数が増えると探索に時間がかかる
  - 階層を作るためには、複数のデータリンクに分けるためにネットワーク層で IP アドレスのような階層的なアドレスが必要になる

#### スイッチの転送方式

- ストア & フォワード
  - イーサネットフレーム末尾の FCS をチェック
  - エラーフレームは転送しない
- カットスルー
  - MAC アドレスが分かり次第データの転送を開始する
  - エラーフレームを転送してしまう場合もある

### 3.2.5 ループを検出するための技術

- ループを作った場合、フレームが次々とコピーされてネットワーク内を回り続ける場合も起こりうる
- メルトダウン
  - 異常なパケットがネットワークを埋め尽くし、通信不能になる状態
  - 一般的に問題となっている機器を切り離さないと解決しない

#### スパンニングツリー

- この機能をもつブリッジを用いる場合に限って、仮にループを作っても問題なく通信できる
  - ブリッジの機能だけで無限ループを回避できる
- 適切な形でループを作ればトラフィックを分散させることができ、耐障害性を高めることができる
- IEEE802,1D で定義されている
- 各ブリッジ缶で1~10秒間の間隔で BPDU (Bridge Protocol Data Unit) というパケットを交換する
- 通信に使うポートと使わないポートを決め、障害が発生した場合は使っていないポートを使うよう通信経路を自動的に変更する
- 障害時の切り替わりに数十秒かかる
  - IEEE802.1D で定義されている RSTP (Rapid Spanning Tree Protocol) は切り替えが数秒以下

#### ソースルーティング

- 送信コンピュータがどのブリッジを経由するか指定する

#### リンクアグリゲーション

- IEEE802.1AX で定義されている
- LAN スイッチ間を複数のリンクで接続する
- スパニングツリーと違い、複数のポートを同時に使うことができる

#### LLDP (Link Layer Discovery Protocol)

- IEEE802.1AB で定義
- ネットワークにつながっている機器の情報を取得
- 各ネットワーク機器が自身のホスト名、機器情報、ポート・インターフェイス情報を定期的にマルチキャスト MAC アドレスで送信し、その LLDP パケットを収集

#### VLAN (Virtual LAN)

- ネットワークの配線を変えずにネットワークの構成を変更することができる
- ブリッジ・L2 スイッチのほかに異なる VLAN 間の通信をすべて遮断
  - ブロードキャストパケットのような余分なパケットが流れないため効率的に運用できる
- スイッチのポートごとに仮想的にセグメントを分割する
  - 異なるセグメント間で通信するにはルータ機能のある L3 スイッチかルータを介す必要がある

##### タグ VLAN

- IEEE802.1Q
- セグメントごとに一意となる VLAN ID を設定
- スイッチ間で通信するときは VLAN ID をイーサネットのヘッダの中に挿入し、その値をもとにしてどのセグメントにフレームを送信するか決定する
